<%- include('../partials/users/userHeader') %>

    <!-- Breadcrumb Section Begin -->
    <section class="breadcrumb-option">
        <div class="container">
            <div class="row">
                <div class="col-lg-12">
                    <div class="breadcrumb__text">
                        <h4>Check Out</h4>
                        <div class="breadcrumb__links">
                            <a href="/">Home</a>
                            <a href="/loadCartPage">cart</a>
                            <span>Check Out</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Breadcrumb Section End -->

    <!-- Checkout Section Begin -->
    <section class="checkout spad">
        <div class="container">
            <div class="row">
                <div class="col-lg-6">

                    <div class="cart__discount col-9">
                        <h6>Discount codes</h6>
                        <form action="#">
                            <input type="text" placeholder="Coupon code">
                            <button type="submit">Apply</button>
                        </form>
                    </div>
                    <!-- Address Selection Section -->
                    <div class=" p-4 rounded mt-5 col-10">
                        <% if (addresses.length===0) { %>
                            <p>No addresses found. Please add one to place an order.</p>
                            <button class="btn btn-success" onclick="window.location.href='/loadAddAddressPage'">Add
                                Address</button>
                            <% } else { %>
                                <button class="btn btn-dark rounded-0 py-2 "
                                    onclick="window.location.href='/loadAddAddressPage'">Add Another
                                    Address</button>
                                <% addresses.forEach((address, index)=> { %>
                                    <div
                                        class="address_item border my-3 p-3 rounded-0 <%= address.isActive ? 'border-success' : 'border-dark' %> d-flex justify-content-between align-items-start">
                                        <div class="address_info w-100">
                                            <div class="d-flex justify-content-between">
                                                <div>
                                                    <input type="radio" name="selectedAddress" id="address-<%= index %>"
                                                        value="<%= address._id %>" <%=address.isActive ? 'checked' : ''
                                                        %> onchange="selectAddress('<%= address._id %>')">
                                                        <label for="address-<%= index %>"
                                                            class="<%= address.isActive ? 'text-success h6' : '' %>">
                                                            <%= address.addressType %>
                                                                <%= address.isActive ? ' (Primary Address)' : '' %>
                                                        </label>
                                                </div>
                                                <button class="btn btn-dark rounded-0 mb-1 btn-sm"
                                                    onclick="window.location.href='/loadEditAddressPage?id=<%= address._id %>'">Edit</button>
                                            </div>
                                            <p class="mb-1"><strong>Name:</strong>
                                                <%= address.name %> &nbsp; <strong>Phone:</strong>
                                                    <%= address.phone %> , <%= address.altPhone %>
                                            </p>
                                            <p class="mb-1">
                                                <%= address.locality %>, <%= address.city %>, <%= address.landMark %>,
                                                            <%= address.state %>, <%= address.pincode %>
                                            </p>
                                        </div>
                                    </div>
                                    <% }); %>

                                        <% } %>
                    </div>
                    <hr>
                    <!-- End Address Selection Section -->


                </div>

                <div class="col-lg-6 col-md-6">




                    <div class="checkout__order">
                        <h4 class="order__title">Your order</h4>
                        <div class="checkout__order__products">Product <span>Total</span></div>
                        <ul class="checkout__total__products">
                            <% products.forEach((product,id)=> { %>
                                <li>
                                    <%= id+1 %> . <%= product.productName %>* <label id="product-quantity">
                                                <%= product.quantity %>
                                            </label>
                                            <span id="total-price-<%= product._id %>">₹<%= product.totalPrice %>
                                                <span class="d-none" id="variationID"><%= product.variationID %></span>
                                                <span class="d-none" id="productID"><%= product.productId %></span>
                                            </span>
                                </li>
                                <% }); %>
                        </ul>
                        <ul class="checkout__total__all">
                            <li>Coupon Applied <span>- ₹ 0</span></li>
                            <li>Discount Price <span>- ₹ 0</span></li>
                            <li>Delivery Charges <span>Free Delivery</span></li>
                            <hr>
                            <li>Subtotal <span id="cart-subtotal">₹<%= (products.reduce((total, product)=> total
                                        +
                                        product.totalPrice, 0)).toFixed(2) %></span></li>

                            <li>Tax (10%) <span id="cart-tax">₹ <%= tax %></span></li>
                            <hr>
                            <li>Total <span id="cart-total">₹<%= (products.reduce((total, product)=> total +
                                        product.totalPrice, tax)).toFixed(2) %></span></li>
                        </ul>


                        <div class="checkout__input__checkbox">
                            <label for="payment-COD">
                                Cash On Delivery
                                <input type="radio" id="payment-COD" name="payment-method" checked>
                                <span class="checkmark"></span>
                            </label>
                        </div>
                        <div class="checkout__input__checkbox">
                            <label for="payment-wallet">
                                Wallet
                                <input type="radio" id="payment-wallet" name="payment-method">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                        <div class="checkout__input__checkbox">
                            <label for="payment-card">
                                Credit/Debit cards
                                <input type="radio" id="payment-card" name="payment-method">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                        <div class="checkout__input__checkbox">
                            <label for="payment-paypal">
                                Paypal
                                <input type="radio" id="payment-paypal" name="payment-method">
                                <span class="checkmark"></span>
                            </label>
                        </div>
                        <button type="button" class="site-btn" onclick="placeOrder()" id="placeOrderButton">PLACE
                            ORDER</button>

                    </div>
                </div>
            </div>
            </form>
        </div>
        </div>
    </section>
    <!-- Checkout Section End -->

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>


    <script>



        function gatherCheckoutData() {
            const orderedItems = [];
            document.querySelectorAll('.checkout__total__products li').forEach(item => {
                const productId = item.querySelector('#productID')?.textContent // Extract product ID from span id
                const quantity = parseInt(item.querySelector('#product-quantity')?.textContent || 1, 10); // Default to 1 if not found
                const price = parseFloat(item.querySelector('span').innerText.replace('₹', ''));
                const variationID = item.querySelector('#variationID')?.textContent
                orderedItems.push({ productId, quantity, price, variationID });
            });
            
            
            const subtotal = parseFloat(document.querySelector('#cart-subtotal').innerText.replace('₹', ''));
            const tax = parseFloat(document.querySelector('#cart-tax').innerText.replace('₹', ''));
            const totalPrice = parseFloat(document.querySelector('#cart-total').innerText.replace('₹', ''));
            const selectedAddressId = document.querySelector('input[name="selectedAddress"]:checked')?.value;
            const paymentMethod = document.querySelector('input[name="payment-method"]:checked')?.id.split('-')[1];
            // const paymentMethod = "COD"
            return {
                orderedItems,//
                subtotal,
                tax,
                totalPrice,
                selectedAddressId,
                paymentMethod//
            };
        }

        function placeOrder() {

            const orderData = gatherCheckoutData();

            
            axios.post('/placeOrder', orderData)
                .then(response => {
                    if (response.data.success) {
                        Swal.fire({
                            title: 'Order Success!',
                            text: 'Your order has been placed successfully!',
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: false,
                        }).then(()=>{
                            window.location.href = `/orderSuccess/${response.data.orderId}`;

                        })
                    } else {
                        Swal.fire({
                            title: 'Error!',
                            text: 'Failed to place order. Please try again.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                    }
                })
                .catch(error => {
                    console.error('Error placing order:', error);
                    Swal.fire({
                            title: 'Error!',
                            text: 'An error occurred while placing your order. Please try again.',
                            icon: 'error',
                            confirmButtonText: 'OK'
                        });
                });

        }

    </script>

    <%- include('../partials/users/userFooter') %>